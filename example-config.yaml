# Hoymiles SunSpec Proxy - Example Configuration
#
# This ESPHome component bridges Hoymiles microinverters (via DTU-Pro RS-485)
# to Victron's GX device, presenting aggregated data as a SunSpec Modbus TCP server.
#
# All sensors are auto-generated based on this configuration - no manual
# template sensors needed.

esphome:
  name: sunspec-bridge
  friendly_name: SunSpec Bridge

esp32:
  board: esp32-s3-devkitc-1
  flash_size: 16MB
  framework:
    type: esp-idf

logger:
  level: INFO

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "SunSpec-Bridge Fallback"
    password: !secret fallback_password

captive_portal:

# Import the SunSpec proxy component
external_components:
  - source:
      type: git
      url: https://github.com/Geoffn-Hub/esphome-sunspec-proxy
      ref: main
    components: [sunspec_proxy]

# UART for RS-485 connection to Hoymiles DTU-Pro
uart:
  id: uart_bus
  tx_pin: GPIO17
  rx_pin: GPIO18
  baud_rate: 9600
  rx_buffer_size: 512

# =============================================================
# SunSpec Proxy Configuration
# =============================================================
sunspec_proxy:
  id: sunspec_bridge
  uart_id: uart_bus

  # TCP server settings (what Victron connects to)
  tcp_port: 502
  unit_id: 126

  # Aggregated device identity (what Victron sees)
  phases: 3                           # Combined output is 3-phase
  rated_voltage_v: 230
  manufacturer: "Fronius"             # Best Victron compatibility
  model_name: "Hoymiles Bridge"
  serial_number: "HM-BRIDGE-001"

  # Polling settings
  poll_interval_ms: 5000
  rtu_timeout_ms: 3000

  # =============================================================
  # RTU Sources - Physical Hoymiles Inverters
  # =============================================================
  # Each source represents one microinverter connected via the DTU-Pro.
  # The component knows the specs of each model and auto-configures.
  rtu_sources:
    # Single-phase microinverter on garage roof
    - rtu_address: 90
      inverter_model: "HMS-2000-4T"     # Model determines phases, MPPT count, power
      inverter_serial: "1141XXXXXXXX"   # Optional: for identification
      name: "Garage Roof"
      connected_phase: 1                # Single-phase unit feeds L1

      # Sensor selection (optional - these are the defaults)
      sensors:
        power: true
        voltage: true
        current: true
        frequency: true
        energy: true
        today_energy: true
        temperature: true
        alarm_code: true
        link_status: true
        operating_status: true
        # DC side sensors (disabled by default)
        pv_voltage: false
        pv_current: false
        pv_power: false
        alarm_count: false

    # Three-phase microinverter on house roof
    - rtu_address: 91
      inverter_model: "HMT-2000-4T"
      inverter_serial: "1161XXXXXXXX"
      name: "House Roof"
      # No connected_phase needed for 3-phase units

      # Enable DC side monitoring for this inverter
      sensors:
        pv_voltage: true
        pv_current: true
        pv_power: true

  # =============================================================
  # Aggregate Sensors (combined output)
  # =============================================================
  aggregate_sensors:
    power: true
    voltage: true
    current: true
    frequency: true
    energy: true

  # =============================================================
  # Bridge Status Sensors
  # =============================================================
  bridge_sensors:
    tcp_clients: true         # Number of active Modbus TCP connections
    tcp_requests: true        # Total request count
    tcp_errors: true          # Total error count
    victron_connected: true   # Whether GX is actively polling
    power_limit: true         # Current power limit from Victron (%)

# =============================================================
# Additional system sensors
# =============================================================
sensor:
  - platform: uptime
    name: "Bridge Uptime"

  - platform: wifi_signal
    name: "Bridge WiFi Signal"
    update_interval: 60s

# Status LED
output:
  - platform: gpio
    id: output_led_status
    pin: GPIO2

light:
  - platform: binary
    id: led_status
    name: "Status LED"
    output: output_led_status

interval:
  - interval: 3s
    then:
      - light.turn_on: led_status
      - delay: 100ms
      - light.turn_off: led_status
