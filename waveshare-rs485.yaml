# Hoymiles SunSpec Proxy - Waveshare RS485 Board
#
# Bridges Hoymiles microinverters (via DTU-Pro RS-485) to Victron GX
# as a SunSpec Modbus TCP server. All sensors auto-generated.

esphome:
  name: waveshare-rs485
  friendly_name: WaveShare-RS485
  platformio_options:
    board_build.flash_mode: dio

esp32:
  board: esp32-s3-devkitc-1
  flash_size: 16MB
  cpu_frequency: 240MHz
  framework:
    type: esp-idf

logger:
  baud_rate: 0
  level: DEBUG

api:
  encryption:
    key: "YoQ/SVokqzygsdXuNQLniQH+8KavUd3Q3M/M7Gp6vQc="

ota:
  - platform: esphome
    password: "6299eaf4e71fa309e8e82d8989f1079b"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "Waveshare-Rs485 Fallback Hotspot"
    password: "fFyJI7d7cnTC"

network:
  enable_ipv6: True
  min_ipv6_addr_count: 2
  enable_high_performance: True

captive_portal:

# Import SunSpec proxy component
external_components:
  - source:
      type: local
      path: components
    components: [sunspec_proxy]
    refresh: 0s

# UART for RS-485 to Hoymiles DTU-Pro
uart:
  id: uart_bus
  tx_pin: GPIO17
  rx_pin: GPIO18
  baud_rate: 9600
  rx_buffer_size: 512

# =============================================================
# SunSpec Proxy Configuration (Hoymiles Modbus Mode)
# =============================================================
#
# This component polls a Hoymiles DTU-Pro via RS-485 Modbus RTU
# and presents the aggregated data as a SunSpec-compliant device
# over Modbus TCP for Victron energy meters.
#
# WIRING:
#   Waveshare RS485 ETH (A+/B-) <---> DTU-Pro RS-485 port
#
# DTU-PRO SETUP:
#   1. Enable Modbus in Hoymiles app/web interface
#   2. Set DTU Modbus address (default: 126)
#   3. Match baud rate (default: 9600, 8N1)
#
# PORT NUMBERS:
#   Port 0 = First inverter connected to DTU
#   Port 1 = Second inverter, etc.
#   (These correspond to the order shown in Hoymiles app)
#
sunspec_proxy:
  id: sunspec_bridge
  uart_id: uart_bus
  tcp_port: 502                     # Modbus TCP port for Victron
  poll_interval_ms: 5000            # How often to poll all inverters
  rtu_timeout_ms: 3000              # Timeout for DTU response
  dtu_address: 126                  # DTU-Pro Modbus address

  # Aggregated device identity (what Victron sees as a single PV inverter)
  unit_id: 126                      # SunSpec TCP unit ID
  phases: 3                         # Three-phase aggregate output
  rated_voltage_v: 230
  manufacturer: "Fronius"           # Fronius for best Victron compatibility
  model_name: "Hoymiles Bridge"
  serial_number: "HM-BRIDGE-001"

  # Physical inverters (ports on the DTU)
  # Each inverter is identified by its port number (0, 1, 2...)
  rtu_sources:
    - port: 0                       # First inverter (Port 0)
      inverter_model: "HMS-2000-4T"
      inverter_serial: ""           # Leave blank to auto-read from DTU
      name: "Garage Roof"
      connected_phase: 1            # Single-phase inverter on L1

    - port: 1                       # Second inverter (Port 1)
      inverter_model: "MIT-5000-8T" # Use GENERIC-3P if not in list
      inverter_serial: ""
      name: "House Roof"
      # 3-phase inverters output on all phases automatically

  # Aggregate sensors (combined output)
  aggregate_sensors:
    power: true
    voltage: true
    current: true
    frequency: true
    energy: true

  # Bridge status sensors
  bridge_sensors:
    tcp_clients: true
    tcp_requests: true
    tcp_errors: true
    victron_connected: true
    power_limit: true

# =============================================================
# Additional System Sensors
# =============================================================
sensor:
  - platform: uptime
    name: "Uptime"

  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

# Status LED
output:
  - platform: gpio
    id: output_led_status
    pin: GPIO2

light:
  - platform: binary
    id: led_status
    name: "Status LED"
    output: output_led_status

interval:
  - interval: 3s
    then:
      - light.turn_on: led_status
      - delay: 100ms
      - light.turn_off: led_status
